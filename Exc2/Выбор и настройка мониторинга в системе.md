# Выбор и настройка мониторинга в системе

## Мотивация
Мониторинг критически важен для обеспечения стабильной работы системы и оперативного реагирования на проблемы. С переходом на оформление заказов через API, данные из Яндекс Метрики уже не дают полной картины, что снижает прозрачность работы системы.

Внедрение мониторинга:
- Повысит оперативность обнаружения проблем.
- Поможет отслеживать ключевые метрики производительности.
- Обеспечит данные для анализа и улучшения пользовательского опыта.
- Уменьшит вероятность возникновения проблем, влияющих на бизнес.
- Сократит время восстановления после инцидентов.

Ключевые бизнес-метрики, которые улучшатся благодаря мониторингу:
- Время обработки заказов.
- Процент успешных заказов.
- Доступность сервисов.
- Удовлетворённость клиентов.

## Выбор подхода к мониторингу
Для мониторинга разных частей системы будут применяться следующие подходы:

1. **Подход RED (Rate, Errors, Duration):**
   Применяется для API и очередей RabbitMQ.
   - Rate: Количество запросов в секунду для каждого API.
   - Errors: Процент запросов с ошибками.
   - Duration: Время обработки каждого запроса.

2. **Подход USE (Utilization, Saturation, Errors):**
   Применяется для серверов и баз данных.
   - Utilization: Уровень использования CPU и памяти.
   - Saturation: Очередь запросов к ресурсам.
   - Errors: Количество ошибок в работе компонентов.

3. **Четыре золотых сигнала (Latency, Traffic, Errors, Saturation):**
   Используется для анализа взаимодействий между компонентами системы.

### Метрики для отслеживания

#### API:
1. **Время отклика (Latency):**
   - Зачем: Позволяет измерить производительность API.
   - Ярлыки: Метод, статус-код, имя сервиса.
2. **Процент ошибок (Errors):**
   - Зачем: Отслеживание стабильности работы API.
   - Ярлыки: Метод, статус-код.
3. **Количество запросов (Traffic):**
   - Зачем: Оценка нагрузки.
   - Ярлыки: Метод.

#### RabbitMQ:
1. **Глубина очереди:**
   - Зачем: Обнаружение задержек в обработке сообщений.
   - Ярлыки: Название очереди.
   ```shell
rabbitmqctl list_queues name messages```
2. **Процент сообщений с ошибками:**
   - Зачем: Анализ стабильности обработки.
   - Ярлыки: Тип ошибки, название очереди.

#### База данных:
1. **Уровень использования CPU и памяти:**
   - Зачем: Избежание перегрузок.
   - Ярлыки: Инстанс.
2. **Время выполнения запросов:**
   - Зачем: Выявление медленных операций.
   - Ярлыки: Тип операции.
3. **Процент ошибок:**
   - Зачем: Обнаружение проблем с доступностью.
   - Ярлыки: Инстанс, тип ошибки.
4. **Количество ордеров в статусе:SUBMITTED**
   - Зачем: Обнаружение проблем с производительностью сервиса определения цены.
   - Ярлыки: Таблица.
4. **Количество ордеров в статусе:MANUFACTURING_APPROVED**
   - Зачем: Обнаружение проблем с операторами.
   - Ярлыки: Таблица.
   
#### Общие метрики:
1. **Доступность сервисов:**
   - Зачем: Мониторинг uptime.
   - Ярлыки: Название сервиса.
2. **Количество активных соединений:**
   - Зачем: Анализ нагрузок.
   - Ярлыки: Сервис, пользователь.

## План действий
1. Создать инстанс time-series базы данных (например, Prometheus) для сбора метрик.
2. Внедрить библиотеку для мониторинга (например, OpenTelemetry) в API.
3. Настроить экспорт метрик из RabbitMQ.
4. Добавить плагины для мониторинга баз данных (например, PostgreSQL Exporter).
5. Настроить систему визуализации (например, Grafana) для построения дашбордов.
6. Определить алерты для критических метрик.

## Показатели насыщенности

### Пороговые значения:
1. **Время отклика API:** >500 мс.
   - Действие: Уведомление команды разработчиков.
2. **Глубина очереди RabbitMQ:** >1000 сообщений.
   - Действие: Добавление инстансов или увеличение ресурсов.
3. **Уровень использования CPU:** >85%.
   - Действие: Добавление ресурсов или масштабирование.
4. **Процент ошибок API:** >5%.
   - Действие: Открытие тикета и проверка логов.

### Реакция на превышение:
- Уведомление ответственных лиц через Slack или почту.
- Автоматическое масштабирование сервисов.
- Заведение тикетов в систему управления инцидентами.

