# Архитектурное решение по трейсингу

## Анализ системы

1. **C4-диаграмма и точки сбоя:**
   - Проведен анализ текущей системы компании.
   - Идентифицированы следующие ключевые места, где заказ может зависнуть или сломаться:
     - MES API: Возможны проблемы с распределением заказов и расчетом стоимости.
     - Message Queue: Потеря сообщений о статусах заказов или новых заказах.
     - Shop API: Ошибки при загрузке 3D-файлов или управлении заказами.
     - CRM API: Возможные сбои в обработке запросов о взаимодействии с клиентами.
     - Shop DB: Потенциальные конфликты записи или недоступность данных.

   - Схема с выделенными зонами риска приложена [ссылка на обновленную C4-диаграмму](../diagram/jewerly_c4_traicing1_model.drawio)

## Список данных для трейсинга

Для полноты картины трейсинга необходимо фиксировать:

- **Уникальный идентификатор запроса (trace_id):** Для отслеживания всей цепочки.
- **Время запроса и ответа:** Для диагностики задержек.
- **Статус обработки:** Успешно/Ошибка.
- **Детали ошибок:** Сообщение и код ошибки.
- **Идентификатор пользователя или сессии:** Для связи с клиентом.
- **Детали взаимодействия с базой данных:** Запросы, время выполнения.
- **Логи взаимодействия между сервисами:** Сообщения в очередях.

## Мотивация

### Зачем добавлять трейсинг?

Внедрение трейсинга позволит:
1. Быстро находить и устранять точки отказа в системе.
2. Улучшить взаимодействие между командами разработки и поддержки.
3. Повысить общую надежность и прозрачность процессов обработки заказов.

### Метрики эффективности:

- **Технические:**
  - Среднее время диагностики инцидента (MTTD).
  - Среднее время восстановления (MTTR).

- **Бизнес-метрики:**
  - Увеличение количества успешно завершенных заказов.
  - Снижение количества потерянных заказов.
  - Повышение удовлетворенности клиентов (NPS).

## Предлагаемое решение

1. **Технологии и инструменты:**
   - **OpenTelemetry:** Для сбора и обработки трейсинговых данных.
   - **Jaeger:** Для визуализации цепочек запросов.
   - **Prometheus + Alertmanager:** Для мониторинга и алертинга.
   - **Обновление кода API и очередей сообщений:** Внедрение trace_id в заголовки запросов и сообщения RabbitMQ.

2. **Необходимые изменения:**
   - Добавить middleware для генерации и передачи trace_id.
   - Настроить сбор метрик и логов на каждом уровне.
   - Интегрировать с системой визуализации.

3. **Доработанная схема системы:**
   - [Ссылка на обновленную диаграмму с новыми компонентами и связями].
   - Новые элементы выделены красным цветом.

4. **Автоматический мониторинг и алертинг:**
   - Настроить правила для автоматического оповещения при превышении времени обработки заказа.
   - Добавить дашборды для анализа состояния системы в режиме реального времени.
   - [Ссылка на финальную версию диаграммы с автоматизацией, элементы выделены зелёным цветом].

## Компромиссы

1. **Сложности реализации:**
   - Интеграция с проприетарными системами может потребовать значительных затрат.
   - Высокая нагрузка на инфраструктуру из-за увеличения объема данных для трейсинга.

2. **Ограничения:**
   - Для некоторых legacy-систем трейсинг может быть недоступен или сложен в реализации.

## Аспекты безопасности

1. **Защита данных:**
   - Шифрование данных трейсинга в хранилище.
   - Ограничение доступа к трейсинговой системе.

2. **Аутентификация и авторизация:**
   - Только пользователи с ролью «Поддержка» смогут получить доступ к данным трейсинга.

3. **Мониторинг доступа:**
   - Ведение аудита доступа к системе трейсинга.

## Дополнительное задание

1. **Автоматизация мониторинга:**
   - Построение SLA-дэшбордов для оценки производительности системы.
   - Внедрение webhook-уведомлений для критических алертов.

2. **Доработанная диаграмма:**
   - Новые связи и компоненты для автоматизации указаны зелёным цветом.
   -  [Финальная диаграмма](../diagram/jewerly_c4_traicing_final_model.drawio) .

