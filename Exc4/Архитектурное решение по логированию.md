# Архитектурное решение по логированию

## Мотивация

На данный момент ошибки и нестандартные ситуации в системе разбираются со слов клиента, что требует значительного времени и усилий разработчиков и специалистов поддержки. Внедрение систематического подхода к логированию позволит:

- Быстро выявлять причины сбоев и нестандартных ситуаций.
- Снизить нагрузку на команду поддержки за счёт автоматизации сбора данных.
- Повысить удовлетворённость клиентов за счёт сокращения времени решения их проблем.
- Улучшить качество продукта путём анализа и устранения скрытых проблем.

**Технические и бизнес-метрики, на которые повлияет внедрение логирования:**

1. Время реакции на инциденты.
2. Доля инцидентов, решённых без участия клиента.
3. Количество запросов в поддержку по техническим вопросам.
4. Уровень удовлетворённости клиентов.
5. Среднее время выполнения запросов на сервисах.

## Список необходимых логов с уровнем INFO

### MES API
- Изменение статуса заказа: время, идентификатор клиента, номер заказа, новый статус.
- Запрос на распределение заказов: идентификатор оператора, номер заказа, результат выполнения.

### Messages Queue (RabbitMQ)
- Публикация сообщений: тип сообщения, время публикации, идентификатор сообщения.
- Получение сообщения: время, идентификатор сообщения, статус обработки.

### Internet Shop
- Авторизация пользователя: идентификатор пользователя, время входа, результат.
- Размещение заказа: время, номер заказа, идентификатор пользователя.
- Загрузка 3D-моделей: идентификатор файла, время загрузки, идентификатор пользователя.

### Shop API
- Создание нового заказа: идентификатор пользователя, номер заказа, время создания.
- Обновление данных о заказе: номер заказа, изменённые параметры, время.

### CRM API
- Получение данных о клиентах: идентификатор клиента, время запроса, источник запроса.
- Изменение данных о клиенте: идентификатор клиента, изменённые параметры, время.

### Shop DB
- Запросы к базе данных: тип операции (чтение/запись), таблица, время выполнения.

## Использование других уровней логирования

- **DEBUG**: для детальной отладки при разработке (например, внутренние состояния методов).
- **ERROR**: для записи критических ошибок, которые требуют немедленного внимания.
- **WARN**: для потенциально проблемных ситуаций, которые не приводят к сбоям.
- **FATAL**: для аварийных ситуаций, которые приводят к остановке приложения.

## Системы, для которых логирование и трейсинг нужно настраивать в первую очередь

1. **MES API**: Часто участвует в изменении статуса заказов, что является критичным для бизнеса.
2. **Messages Queue**: Проблемы с потерей сообщений напрямую влияют на выполнение заказов.
3. **Shop API**: Основной интерфейс для размещения заказов.

## Предлагаемое решение

### Технологии для реализации логирования

- **Elastic Stack (ELK)**: для сбора, хранения и анализа логов.
- **OpenTelemetry**: для унифицированного сбора данных из различных систем.
- **Logstash**: для парсинга и трансформации логов.
- **Kibana**: для визуализации и анализа данных.

### Компоненты для внедрения

1. Интеграция OpenTelemetry SDK в API-сервисы.
2. Настройка агентов Logstash для обработки логов из RabbitMQ и других источников.
3. Развёртывание ElasticSearch для хранения данных.
4. Настройка Kibana для создания дашбордов и поиска аномалий.

### Политика безопасности

- Шифрование логов при передаче и хранении.
- Ограничение доступа к логам: доступ только для авторизованных сотрудников с соответствующими ролями.
- Удаление или маскирование чувствительных данных (например, персональных данных клиентов).

### Политика хранения

- Создание отдельных индексов для каждой системы.
- Срок хранения логов: 30 дней для оперативного анализа, архивирование старых логов.
- Лимит на размер индекса: автоматическая ротация при достижении предела.

### Мероприятия для превращения системы сбора логов в систему анализа логов

1. Настройка алертинга на основе аномалий в логах (например, резкое увеличение числа ошибок).
2. Автоматический анализ трендов (например, увеличение времени выполнения запросов).
3. Интеграция с системами уведомлений (email, Slack, PagerDuty).

## Дополнительное задание: критерии выбора технологии для логирования

| Критерий                  | Elastic Stack         | OpenSearch           | Splunk              | Graylog             |
|---------------------------|-----------------------|----------------------|---------------------|---------------------|
| Лицензия                 | Elastic License      | Apache 2.0          | Проприетарная       | Open Source         |
| Масштабируемость         | Высокая              | Высокая             | Очень высокая       | Средняя             |
| Стоимость                | Бесплатно/платно     | Бесплатно           | Высокая             | Бесплатно           |
| Простота настройки       | Средняя              | Средняя             | Высокая             | Высокая             |
| Сообщество               | Большое              | Растущее            | Ограниченное        | Ограниченное        |

Для реализации решения выбрана **Elastic Stack**, так как он предлагает широкий функционал, масштабируемость и развитое сообщество.

